### Payroll Execution API Tests
### Complete test suite for all requirements (REQ-PY-*) and business rules (BR-*)
### Base URL
@baseUrl = http://localhost:3000/api
@token = your_jwt_token_here

### ============ SIGNING BONUS TESTS ============

### REQ-PY-28: Get all signing bonuses
GET {{baseUrl}}/payroll-execution/signing-bonuses
Authorization: Bearer {{token}}

### Get signing bonuses by status (pending)
GET {{baseUrl}}/payroll-execution/signing-bonuses?status=pending
Authorization: Bearer {{token}}

### Get signing bonuses by status (approved)
GET {{baseUrl}}/payroll-execution/signing-bonuses?status=approved
Authorization: Bearer {{token}}

### Get specific signing bonus by ID
GET {{baseUrl}}/payroll-execution/signing-bonuses/{{bonusId}}
Authorization: Bearer {{token}}

### REQ-PY-29: Edit signing bonus (BR 25: requires authorization)
POST {{baseUrl}}/payroll-execution/signing-bonuses/{{bonusId}}/edit
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "amount": 5000,
  "note": "Adjusted based on negotiation",
  "paymentDate": "2025-12-31T00:00:00.000Z"
}

### REQ-PY-28: Approve single signing bonus (BR 28: disbursed only once)
POST {{baseUrl}}/payroll-execution/signing-bonuses/{{bonusId}}/approve
Authorization: Bearer {{token}}

### REQ-PY-28: Approve all pending signing bonuses
POST {{baseUrl}}/payroll-execution/approve-signing-bonuses
Authorization: Bearer {{token}}

### ============ TERMINATION/RESIGNATION BENEFITS TESTS ============

### Get all termination benefits
GET {{baseUrl}}/payroll-execution/termination-benefits
Authorization: Bearer {{token}}

### Get termination benefits by status (pending)
GET {{baseUrl}}/payroll-execution/termination-benefits?status=pending
Authorization: Bearer {{token}}

### Get specific termination benefit by ID
GET {{baseUrl}}/payroll-execution/termination-benefits/{{benefitId}}
Authorization: Bearer {{token}}

### REQ-PY-32: Edit termination benefit (BR 27: requires approval)
POST {{baseUrl}}/payroll-execution/termination-benefits/{{benefitId}}/edit
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "givenAmount": 15000,
  "note": "Adjusted based on contract terms"
}

### REQ-PY-31: Approve termination benefit (BR 26: requires clearance)
POST {{baseUrl}}/payroll-execution/termination-benefits/{{benefitId}}/approve
Authorization: Bearer {{token}}

### ============ PAYROLL INITIATION TESTS ============

### REQ-PY-23: Create payroll initiation (BR 63: with validation)
POST {{baseUrl}}/payroll-execution/initiation
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "payrollPeriod": "2025-12-31T00:00:00.000Z",
  "entity": "TechCorp Egypt",
  "employees": 0,
  "exceptions": 0,
  "totalnetpay": 0
}

### Get payroll initiation by ID
GET {{baseUrl}}/payroll-execution/initiation/{{initiationId}}
Authorization: Bearer {{token}}

### REQ-PY-26: Edit payroll initiation (only draft or rejected)
PATCH {{baseUrl}}/payroll-execution/initiation/{{initiationId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "payrollPeriod": "2025-12-31T23:59:59.999Z",
  "entity": "TechCorp Egypt Updated",
  "employees": 50,
  "exceptions": 2,
  "totalnetpay": 250000
}

### REQ-PY-24: Approve payroll initiation (triggers REQ-PY-23 processing)
POST {{baseUrl}}/payroll-execution/initiation/{{initiationId}}/approve
Authorization: Bearer {{token}}

### Reject payroll initiation with reason
POST {{baseUrl}}/payroll-execution/initiation/{{initiationId}}/reject
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "reason": "Incorrect period selected, needs correction"
}

### ============ PAYROLL APPROVAL WORKFLOW TESTS ============

### REQ-PY-22: Manager approval (BR 30: multi-step approval)
POST {{baseUrl}}/payroll-execution/{{payrollRunId}}/approve
Authorization: Bearer {{token}}

### REQ-PY-15: Finance approval (BR 18: final validation, marks as paid)
POST {{baseUrl}}/payroll-execution/{{payrollRunId}}/approve-finance
Authorization: Bearer {{token}}

### REQ-PY-7: Freeze/lock payroll (prevents unauthorized changes)
POST {{baseUrl}}/payroll-execution/{{payrollRunId}}/freeze
Authorization: Bearer {{token}}

### REQ-PY-19: Unfreeze payroll (requires reason)
POST {{baseUrl}}/payroll-execution/{{payrollRunId}}/unfreeze
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "reason": "Emergency correction needed for employee ID 12345"
}

### REQ-PY-8: Generate payslips (after finance approval)
POST {{baseUrl}}/payroll-execution/{{payrollRunId}}/generate-payslips
Authorization: Bearer {{token}}
Content-Type: application/json

{}

### ============ VIEWING AND REPORTING TESTS ============

### REQ-PY-6: Get payroll draft/run details for review
GET {{baseUrl}}/payroll-execution/draft/{{payrollRunId}}
Authorization: Bearer {{token}}

### ============ EDGE CASE TESTS ============

### Test: Try to edit PAID signing bonus (should fail)
POST {{baseUrl}}/payroll-execution/signing-bonuses/{{paidBonusId}}/edit
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "amount": 10000
}

### Test: Try to approve already APPROVED bonus (BR 28 violation - should fail)
POST {{baseUrl}}/payroll-execution/signing-bonuses/{{approvedBonusId}}/approve
Authorization: Bearer {{token}}

### Test: Try to edit locked payroll (should fail)
PATCH {{baseUrl}}/payroll-execution/initiation/{{lockedPayrollId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "totalnetpay": 999999
}

### Test: Try to approve termination benefit without clearance (BR 26 - should fail)
POST {{baseUrl}}/payroll-execution/termination-benefits/{{benefitWithoutClearanceId}}/approve
Authorization: Bearer {{token}}

### Test: Create duplicate payroll period (should fail)
POST {{baseUrl}}/payroll-execution/initiation
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "payrollPeriod": "2025-12-31T00:00:00.000Z",
  "entity": "TechCorp Egypt",
  "employees": 0,
  "exceptions": 0,
  "totalnetpay": 0
}

### Test: Try to create payroll for future date (should fail)
POST {{baseUrl}}/payroll-execution/initiation
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "payrollPeriod": "2026-12-31T00:00:00.000Z",
  "entity": "TechCorp Egypt",
  "employees": 0,
  "exceptions": 0,
  "totalnetpay": 0
}

### Test: Try to unfreeze non-frozen payroll (should fail)
POST {{baseUrl}}/payroll-execution/{{draftPayrollId}}/unfreeze
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "reason": "Test reason"
}

### Test: Reject initiation without reason (should fail)
POST {{baseUrl}}/payroll-execution/initiation/{{initiationId}}/reject
Authorization: Bearer {{token}}
Content-Type: application/json

{}

### Test: Finance approve before manager approval (should fail)
POST {{baseUrl}}/payroll-execution/{{payrollRunId}}/approve-finance
Authorization: Bearer {{token}}

### ============ COMPLETE WORKFLOW TEST ============

### Step 1: Create payroll initiation
# @name createInitiation
POST {{baseUrl}}/payroll-execution/initiation
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "payrollPeriod": "2025-12-31T00:00:00.000Z",
  "entity": "TechCorp Egypt",
  "employees": 0,
  "exceptions": 0,
  "totalnetpay": 0
}

### Step 2: Approve initiation (starts processing)
@initiationId = {{createInitiation.response.body._id}}
POST {{baseUrl}}/payroll-execution/initiation/{{initiationId}}/approve
Authorization: Bearer {{token}}

### Step 3: Manager approves payroll
POST {{baseUrl}}/payroll-execution/{{initiationId}}/approve
Authorization: Bearer {{token}}

### Step 4: Finance approves payroll (marks as paid)
POST {{baseUrl}}/payroll-execution/{{initiationId}}/approve-finance
Authorization: Bearer {{token}}

### Step 5: Freeze payroll
POST {{baseUrl}}/payroll-execution/{{initiationId}}/freeze
Authorization: Bearer {{token}}

### Step 6: Generate and distribute payslips
POST {{baseUrl}}/payroll-execution/{{initiationId}}/generate-payslips
Authorization: Bearer {{token}}
Content-Type: application/json

{}

### Step 7: View final payroll details
GET {{baseUrl}}/payroll-execution/draft/{{initiationId}}
Authorization: Bearer {{token}}

### ============ SALARY CALCULATION INTEGRATION TESTS ============

### Test: Verify Time Management integration (working hours, overtime, penalties)
# Expected: Payroll should include attendance data, overtime pay, and work penalties
# - actualWorkMinutes from attendance records
# - overtimeMinutes calculated at 1.5x hourly rate
# - missingWorkMinutes deducted at hourly rate
# - latenessMinutes deducted at 50% hourly rate
GET {{baseUrl}}/payroll-execution/draft/{{payrollWithAttendance}}
Authorization: Bearer {{token}}

### Test: Verify Leaves integration (paid/unpaid leave deduction)
# Expected: Unpaid leave days should reduce working days and affect salary
# - Unpaid leave days deducted from working days
# - Paid leave does not affect salary calculation
# - Leave period must overlap with payroll period
GET {{baseUrl}}/payroll-execution/draft/{{payrollWithLeaves}}
Authorization: Bearer {{token}}

### Test: Complex scenario - mid-month hire with overtime and unpaid leave
# Expected:
# - Prorated salary based on hire date
# - Overtime pay added at 1.5x rate
# - Unpaid leave days deducted
# - Missing work penalty applied
POST {{baseUrl}}/payroll-execution/initiation
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "payrollPeriod": "2025-12-31T00:00:00.000Z",
  "entity": "TechCorp Egypt",
  "employees": 0,
  "exceptions": 0,
  "totalnetpay": 0
}

### ============ NET PAY FORMULA VERIFICATION ============

### Formula: netPay = (netSalary - penalties + overtime + refunds + bonuses + benefits)
# Where:
# - netSalary = proratedGross - taxes - insurance
# - penalties = misconductPenalties + missingWorkPenalty + latenessPenalty
# - overtime = (overtimeMinutes / 60) × hourlyRate × 1.5
# - refunds = approved refunds from Payroll Tracking
# - bonuses = approved signing bonuses
# - benefits = approved termination benefits

### Test: Employee with complete data
# Assumptions:
# - Base salary: 10,000 EGP
# - Days worked: 30 days
# - Actual work: 160 hours (9,600 minutes)
# - Scheduled work: 170 hours (10,200 minutes)
# - Missing: 10 hours (600 minutes)
# - Overtime: 5 hours (300 minutes)
# - Lateness: 2 hours (120 minutes)
# - Unpaid leave: 2 days
#
# Expected calculation:
# - hourlyRate = 10,000 / (30 × 8) = 41.67 EGP/hour
# - missingWorkPenalty = (600 / 60) × 41.67 = 416.70 EGP
# - latenessPenalty = (120 / 60) × 41.67 × 0.5 = 41.67 EGP
# - overtimePay = (300 / 60) × 41.67 × 1.5 = 312.53 EGP
# - totalPenalties = 0 + 416.70 + 41.67 = 458.37 EGP
# - proratedGross = 10,000 × ((30 - 2) / 30) = 9,333.33 EGP
# - netSalary = 9,333.33 - taxes - insurance
# - netPay = netSalary - 458.37 + 312.53 + refunds + bonuses + benefits
GET {{baseUrl}}/payroll-execution/draft/{{payrollRunId}}
Authorization: Bearer {{token}}
